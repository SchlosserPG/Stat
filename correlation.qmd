---
title: "Correlation Analysis"
author: ""
date: "2024-08-09"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, tidy.opts = list(width.cutoff = 70), tidy = TRUE, message=FALSE, warning=FALSE)
```

-   The main goal of this lesson is to understand and conduct correlation analysis and interpret its results. In doing so, we will examine Pearson’s r correlation coefficient and learn how to conduct and interpret an inferential statistical test using this common statistic.

```{r tidy=FALSE}
####################################
# Project name: Covariance and Measures of Association
# Data used: Debt_Payments.csv
# Libraries used: tidyverse, ggplot2
####################################
```

```{r, message=FALSE}
library(tidyverse)
library(ggplot2)
```

### Lesson Objectives

-   Compute and interpret Pearson’s r correlation coefficient.
-   Conduct an inferential statistical test for Pearson’s r correlation coefficient.

### Consider While Reading

-   In the lesson, we are looking at inference for correlation. We will learn how to conduct a correlation test. This will close the loop on scatterplots, which we learned in the Data Visualization lesson help us describe visually a relationship between variables. Consider what we learned and perhaps revisit the scatterplot lecture notes to then determine how visualizations can help in making inferences alongside regression and correlation results.

## Covariance

-   Covariance ($s_{xy}$ or $cov_{xy}$) is a numerical measure that describes the direction of the linear relationship between two variables, x and y and reveals the direction of that linear relationship.
-   The formula for covariance is as follows:
    -   $cov_{xy} = \sum^n_{i=1}(x_i-m_x)*(y_i-m_y)/(n-1)$
    -   Where $x_i$ and $y_i$ are the observed values for each observation, $m_x$ and $m_y$ are the mean values for each variable, $i$ represents an individual observation, and $n$ represents the sample size.

```{r}

x <- c(3, 8, 5, 2)
y <- c(12, 14, 8, 4)

devX <- x-mean(x)
devY <- y-mean(y)

covXY <- sum(devX * devY)/(length(x)-1); covXY

#We can verify this by using cov() function in R.
cov(x,y)
```

## Correlation Coefficient

-   A correlation coefficient ($r_{xy}$) describes both the direction and strength of the relationship between $x$ and $y$. $r_{xy} = cov_{sy}/(s_xs_y)$ or using the standardized formula in the book:
    -   $r_{xy} = \sum^n_{i=1}(z_x*z_y)/(n-1)$

```{r}
#Calculated manually
covXY/(sd(x)*sd(y))

#We can verify this by using cor() function in R.
cor(x,y)

```

### Rules for the Correlation Coefficient

-   The correlation coefficient has the same sign as the covariance; however, its value ranges between −1 and +1 whereas $-1 \le r_{xy} \le +1$.
-   The absolute value of the coefficient reflects the strength of the correlation. So a correlation of −.70 is stronger than a correlation of +.50.

![Correlation Coefficient](Pictures/Ch8/Correlation.png "Correlation Coefficient")

## Interpreting the Direction of the Correlation

-   Negative correlations occur when one variable goes up and the other goes down.
-   No correlation happens when there is no discernible pattern in how two variables vary.
-   Positive correlations occur when one variable goes up, and the other one also goes up (or when one goes down, the other one does too); both variables move together in the same direction.

![Correlation Scatterplots](Pictures/Ch8/RelationshipScatter.png "Correlation Scatterplots")

### Scatterplots to Visualize Relationship

-   Let's do an example to first visualize the data, and then to calculate the correlation coefficient.

-   First, read in a .csv called *DebtPayments.csv*. This data set has 26 observations and 4 variables:

    -   A character variable with a bunch of metropolitan areas listed;
    -   An integer numeric debt;
    -   A numeric variable Income;
    -   A numeric variable Unemployment.

```{r}
Debt_Payments <- read.csv("data/DebtPayments.csv")
str(Debt_Payments)
```

-   Next, plot the relationship between 2 continuous variables.

    -   There are a few ways to write the plot command using ggplot. We went over these in the Data Visualization lesson. Again we said:
    -   Layer 1: ggplot() command with aes() command directly inside of it pointing to x and y variables.
    -   Layer 2: geom_point() command to add the observations as indicators in the chart.
    -   Layer 3 or more: many other optional additions like labs() command (for labels) or stat_smooth() command to generate a regression line.

    ```{r, fig.alt="Scatterplot Using ggplot2 Generated by R"}
    Debt_Payments %>% ggplot(aes(Income, Debt))+ 
      geom_point(color="#183028", shape=2) + 
      stat_smooth(method="lm", color="#789F90") + 
      theme_minimal()
    ```

-   In the above plot, there is a strong positive relationship (upward trend) that should be confirmed with a correlation test.

-   In a second example below, we look at Unemployment as the X variable. This scatterplot is much more difficult to use in determining whether the correlation will be significant. It looks negative, but there is not a strong linear trend to the data. This will also need to be confirmed with a correlation test.

```{r, fig.alt="Scatterplot Using ggplot2 Generated by R"}
Debt_Payments %>% ggplot(aes(Unemployment, Debt))+
  geom_point(color="#183028", shape=2) + 
  stat_smooth(method="lm", color="#789F90") + 
  theme_minimal()
```

-   In many scatterplots using big data, the observations are too numerous to see a good relationship. In that case, the statistical test can trump this visual aid. However, in a lot of cases the scatterplot does help visualize the relationship between 2 continuous variables.

### Interpreting the Strength of the Correlation

-   Statisticians differ on what is called a strong correlation versus weak correlation, and it depends on the context. A .9 may be required for a strong correlation in one field, and a .5 in another. Generally speaking in business, the absolute value of a correlation .8 or above is considered strong, between .5 and .8 is considered moderate, and between a .2 and .5 is considered weak.
-   The following is consistent with what is most generally used:

![Correlation Strength](Pictures/Ch8/CorrelationStrength.png "Correlation Strength")

## Interpreting the Significance of the Correlation

-   Correlation values should be tested alongside a p-value to confirm whether or not there is a correlation. The null is tested using a t-distribution specifically testing whether $r = 0$ or not, like the one-sample t-test section from the lesson 6.
-   The null and alternative are listed below.
    -   $H_0$: There is no relationship between the two variables ($r = 0$).
    -   $H_A$: There is a relationship between the two variables ($r \neq 0$).
-   Even small correlations can be significant: In large datasets, even a small correlation, like .1, can be statistically significant due to the increased power that comes with a high sample size. It's important to interpret both the strength of the correlation and its practical significance in context.

#### Statistical significance answers the question: "Is the effect real?“

-   Statistical Significance:

-   A result is statistically significant if it is unlikely to have occurred by random chance, given a pre-defined threshold (usually p \< 0.05).

-   With larger sample sizes, even very small effects can become statistically significant because larger samples reduce variability. For example, a correlation of 0.1 can be statistically significant with enough data.

-   Practical Significance:

-   Practical significance answers the question: "Is the effect meaningful?“

-   Practical significance refers to the real-world importance or relevance of a result. It asks, "Does this effect matter in practice?“

-   Even if a result is statistically significant, it may not be large enough to have a meaningful impact on business decisions or outcomes.

### cor.test() Command

-   The cor() command gives you just the correlation coefficient. This command can be useful if you are testing many correlations at one time. In the below statement, I can use $cor(Variable1, Variable2)$ to see the correlation between 2 continuous variables.

```{r}
cor(Debt_Payments$Income, Debt_Payments$Debt) 
```

-   The cor.test() command tests the hypothesis whether $r=0$ or not. This command comes with a p-value and t-test statistic (along with the correlation coefficient).

```{r}
cor.test(Debt_Payments$Income, Debt_Payments$Debt)
```

-   This test shows a strong positive correlation of .8675 (\>.8) which is significant. Our p-value is 9.66e-09 or \< .001 alpha level. This suggests that we reject the null hypothesis and support the alternative that $r \neq 0$ which confirms a correlation is present.
-   We also see a confidence interval listed. It suggests that we are 95% confident that the correlation is between .723 and .939.

```{r}
cor.test(Debt_Payments$Income, Debt_Payments$Unemployment)
```

-   This test shows a moderate negative correlation of -.534 (\<.5 and .8) which is significant. Our p-value is 0.004928 or \< .01 alpha level. This suggests that we reject the null hypothesis and support the alternative that $r \neq 0$ which confirms a correlation is present.
-   We also see a confidence interval listed. It suggests that we are 95% confident that the correlation is between -.765 and -.185. This confidence interval is wider than the one listed above. This is due to the noise in the relationship we noted in the scatterplot - the correlation is weaker, the relationship does not look as linear, the confidence decreases. Even though this is true, we must note that we still found a significant correlation.

## Additional Examples

```{r}
library(ISLR)
data("Credit")
summary(Credit)

attach(Credit)

cor.test(Rating, Income) #0.7913776 moderate and positive

cor.test(Rating, Balance) #0.8636252 strong and positive

cor.test(Rating, Limit) #0.9968797 strong and positive
##almost perfectly linear 
ggplot(Credit, aes(Rating, Limit))+geom_point()

cor.test(Rating, Education) #-0.03013563 no correlation

cor.test(Rating, Age) #0.103165 - between -.2 and .2 - so no relationship even though p-value < .05 -- p-value fails at .01 level. 
ggplot(Credit, aes(Rating, Age))+geom_point()+stat_smooth(method="lm")


cor.test(Rating, Cards) #0.05323903 
ggplot(Credit, aes(Rating, Cards))+geom_point()+stat_smooth(method="lm")



```

## Comparing to t.test and ANOVA

-   A t-test examines if there is a significant difference in the means of two groups on a dependent variable. For example, whether males and females differ in their credit ratings, where a correlation measures the strength and direction of a linear relationship between two continuous variables, such as Rating and Income.
-   An independent t-test requires a categorical independent variable (e.g., Gender) with two levels and a continuous dependent variable (e.g., Rating), where a correlation requires two continuous variables.
-   Both can provide insights into relationships in the dataset, but they address different questions. An independent t-test evaluates mean differences (group comparisons), while correlation evaluates relationships (continuous covariation). \* A significant t-test does not imply a strong correlation between the grouping variable and the dependent variable; the correlation would depend on the coding of the categorical variable and the distribution of data

```{r}
## -- Example of an independent t.test using same dataset
t.test(Rating~Gender, data=Credit) ##no group differences
ggplot(Credit, aes(Gender, Rating)) + geom_boxplot()

t.test(Rating~Married, data=Credit)##no group differences
ggplot(Credit, aes(Married, Rating)) + geom_boxplot()


```

-   An ANOVA tests for significant differences in the means of three or more groups on a dependent variable. For example, whether credit ratings differ across ethnic groups, where a correlation examines the strength of the relationship between two continuous variables.
-   An Anova requires a categorical independent variable (with three or more levels) and a continuous dependent variable, where a correlation requires two continuous variables.
-   ANOVA focuses on group comparisons (e.g., Rating differences across Ethnicity), while correlation looks at how two variables change together.A significant ANOVA could suggest that the categorical grouping variable explains some variance in the dependent variable, but this variance is not quantified as a relationship strength (as correlation would provide).

```{r}
## -- Example of An ANOVA using same dataset
anova1 <- aov(Rating~Ethnicity, data=Credit)
anova(anova1) #no group differences - no need for a post hoc test. 
ggplot(Credit, aes(Ethnicity, Rating, fill=Ethnicity)) + geom_boxplot(show.legend=FALSE)
```

## Limitations of Correlation Analysis

-   Note that a correlation is the first step in understanding causality. Correlation and causality are closely related but fundamentally different concepts in data analysis. Correlation refers to the statistical relationship between two variables, indicating how changes in one variable are associated with changes in another. However, it does not imply that one variable causes the other to change. Causality, on the other hand, goes beyond mere association to establish a cause-and-effect relationship, where one variable directly influences the other. Determining causality requires meeting specific criteria, including significant association, temporal precedence (the cause precedes the effect), and ruling out alternative explanations or confounding variables. While correlation is often the first step in exploring potential relationships, additional analysis—such as experimental design or causal modeling—is necessary to confirm causality. This distinction highlights the importance of critical thinking when interpreting statistical results, as a strong correlation alone does not prove that one variable is the cause of another.

-   To determine a causal model, you need the following:

1.  Significant Correlation: Statistically significant relationship between the variables.
2.  Temporal Precedence: Causal variable occurred prior to the other variable.
3.  Eliminate Alternate Variables: No other factors can account for the cause.

-   Some limitations are as follows:
    -   The correlation coefficient captures only a linear relationship.
    -   The correlation coefficient may not be a reliable measure in the presence of outliers.
    -   Even if two variables are highly correlated, one does not necessarily cause the other.
-   When interpreting results, note that lack of significance does not mean a variable X has no relationship with Y; it might suggest a more complex or non-linear relationship.

## Using AI

-   Use the following prompt on a generative AI, like chatGPT, to learn more about correlation analysis.

-   Explain the difference between covariance and correlation. How do you interpret the direction and strength of a correlation coefficient?"

-   What is covariance, and how does it describe the relationship between two variables? Provide an example with a simple dataset. Describe Pearson’s correlation coefficient. How do you calculate it, and what does it tell you about the relationship between two variables?

-   Explain how to create a scatterplot using ggplot2 in R to visualize the relationship between two continuous variables. How can you add a regression line to assess the linearity of the relationship?

-   How can you use the cor.test() function in R to conduct a hypothesis test for correlation? What do the p-value and confidence interval indicate in the context of correlation?

-   How do you interpret the strength and direction of a correlation? What is considered a strong, moderate, or weak correlation in the context of business data?

-   Explain the null and alternative hypotheses for correlation testing. How does the t-distribution play a role in testing the significance of a correlation coefficient?

-   What are some challenges of visualizing relationships between variables when dealing with big data, and how can statistical tests help when scatterplots are not effective?

-   Discuss the limitations of correlation analysis. Why is it important to be cautious when interpreting correlation as causation?

-   What are the key differences between correlation and causation? How can you determine if a correlation implies causality?

## Summary

-   In this lesson, we learned about correlation coefficient and how to evaluate a strong, moderate, or weak/positive or negative correlation. We also learned how to visualize a relationship using a scatterplot. We also learned how to test for a correlation being significant or not.
